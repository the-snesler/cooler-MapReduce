syntax = "proto3";

package mapreduce;

// WorkerService handles task execution from coordinator
service WorkerService {
  rpc AssignTask(TaskAssignment) returns (TaskAck);
  rpc GetTaskStatus(TaskStatusRequest) returns (TaskStatusResponse);

  // RPC for cross-worker Shuffle data transfer
  rpc FetchIntermediateFile(FileRequest) returns (FileResponse);
}

// request for a specific intermediate file by name
message FileRequest {
    string file_name = 1;
}

// response containing the intermediate file's data
message FileResponse {
    bytes file_data = 1; // Binary content of the pickled file
}

// structure to hold the address and file name for one intermediate file chunk
message Location {
  string worker_address = 1;
  string file_name = 2;
}

// Task assignment from coordinator to worker
message TaskAssignment {
  string task_id = 1;
  string task_type = 2;         // MAP or REDUCE
  string job_id = 3;
  string input_path = 4;        // For map: input file, for reduce: intermediate files pattern
  string output_path = 5;       // Output location
  string job_file_path = 6;     // Path to user job file
  int32 partition_id = 7;       // For reduce tasks
  int32 num_reduce_tasks = 8;   // Total number of reduce tasks (for partitioning)
  repeated Location shuffle_locations = 9; // list of intermediate file locations for the shuffle phase for reduce tasks
}

// Acknowledgment of task assignment
message TaskAck {
  string task_id = 1;
  bool accepted = 2;
}

// Request for task status
message TaskStatusRequest {
  string task_id = 1;
}

// Response with task status
message TaskStatusResponse {
  string task_id = 1;
  string status = 2;            // PENDING, RUNNING, COMPLETED, FAILED
  string error_message = 3;     // Error details if status is FAILED
}
